services:
  hype-services:
    container_name: control-plane
    build:
      context: ..
      dockerfile: modules/kuma/control-plane-deployment/Dockerfile
    env_file:
      - .env
      - /etc/environment
    volumes:
      - ..:/workspace:delegated
      - /var/run/docker.sock:/var/run/docker.sock
    privileged: true
    ports:
      - "5681:5681" # Admin REST API
      - "8080:8080" # Kuma GUI
      - "5678:5678" # Dataplane communication
    networks:
      - service-mesh
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5681/"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  deployment-platform:
    container_name: deployment-platform
    build:
      context: ..
      dockerfile: ./modules/dokku/Dockerfile
    ports:
      - "3022:22"
      - "80:80"
      - "8443:443"
    volumes:
      - "/var/lib/dokku:/mnt/dokku"
      - "/var/run/docker.sock:/var/run/docker.sock"
    environment:
      DOKKU_HOSTNAME: dokku.me
      DOKKU_HOST_ROOT: /var/lib/dokku/home/dokku
      DOKKU_LIB_HOST_ROOT: /var/lib/dokku/var/lib/dokku
    restart: unless-stopped
    networks:
      - service-mesh

  docker-in-docker:
    container_name: docker-in-docker
    image: docker:24.0.5-dind
    privileged: true
    environment:
      DOCKER_TLS_CERTDIR: ""
    volumes:
      - ..:/workspace:delegated
      - /var/lib/docker
    networks:
      - service-mesh

networks:
  service-mesh:
    name: service-mesh
    driver: bridge
